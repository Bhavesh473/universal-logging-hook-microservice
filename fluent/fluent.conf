<source>
  @type http
  port 9880
  bind 0.0.0.0
</source>

<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<source>
  @type syslog
  port 5140
  bind 0.0.0.0
  tag nginx
  <parse>
    @type regexp
    expression /^.* nginx_access: (?<message>.+)$/
    types message:string
  </parse>
</source>

<filter nginx.**>
  @type parser
  key_name message
  reserve_data true
  remove_key_name_field true
  <parse>
    @type json
  </parse>
</filter>

<filter **>
  @type record_transformer
  enable_ruby true
  <record>
    level ${record["level"] || "INFO"}
    source ${record["source"] || "unknown"}
    timestamp ${record["timestamp"] || Time.now.utc.iso8601}
    received_at ${Time.now.utc.iso8601}
    event_id ${require 'securerandom'; SecureRandom.uuid}
    session_id ${record["session_id"] || ""}
  </record>
</filter>

<label @FLUENT_LOG>
  <match **>
    @type stdout
  </match>
</label>

<match **>
  @type copy
  <store>
    @type stdout
  </store>
  <store>
    @type http
    endpoint http://replay-sidecar:8200/forward
    <buffer>
      flush_interval 1s
      chunk_limit_size 8MB
    </buffer>
    <format>
      @type json
    </format>
  </store>
</match>